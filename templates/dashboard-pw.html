<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PW - Forum TBM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #5B86A4;
            --secondary: #34495e;
            --dark: #2c3e50;
            --light: #F9FAFB;
            --accent: #4CA1AF;
            --pw-color: #0284c7; /* Warna Biru Laut Khas PW */
            --gradient: linear-gradient(135deg, #5B86A4 0%, #4CA1AF 100%);
        }

        body {
            background-color: var(--light);
            font-family: 'Poppins', sans-serif;
            padding-top: 80px;
        }

        /* Navbar Styles */
        header {
            background-color: white;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .logo-img {
            height: 50px;
            width: auto;
        }

        .nav-menu a {
            text-decoration: none;
            color: var(--secondary);
            font-weight: 500;
            position: relative;
            transition: all 0.3s ease;
        }

        .nav-menu a:hover {
            color: var(--primary);
        }

        /* Buttons */
        .primary-btn {
            background: var(--gradient);
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(91, 134, 164, 0.3);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(91, 134, 164, 0.4);
        }

        .danger-btn {
            background: #ef4444;
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .success-btn {
            background: #10b981;
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        /* Stats Cards */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        /* Tabs */
        .tab-btn {
            padding: 10px 20px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--pw-color);
            border-bottom-color: var(--pw-color);
            background-color: #f0f9ff;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-container {
            background: white;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
        }

        /* Detail Items */
        .detail-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e5e7eb;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            margin-bottom: 8px;
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 8px;
        }

        .detail-label {
            font-weight: 500;
            color: #6b7280;
            font-size: 0.9rem;
        }

        .detail-value {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- Toast Notification --- */
        #toast-notification {
            position: fixed;
            top: 20px;
            right: 50%;
            transform: translate(50%, -50px);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 1rem;
            opacity: 0;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }

        #toast-notification.show {
            opacity: 1;
            transform: translate(50%, 0);
        }

        #toast-notification.success {
            background-color: #d1fae5;
            color: #065f46;
        }

        #toast-notification.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body>

    <header id="header">
        <div class="max-w-6xl mx-auto px-5 w-full">
            <div class="flex justify-between items-center py-2">
                <div class="logo">
                    <a href="index.html">
                        <img src="../static/style/image/Logo-Forum-TBM.png" alt="Logo TBM" class="logo-img">
                    </a>
                </div>

                <ul class="nav-menu flex items-center list-none">
                    <li id="profile-dropdown" class="relative">
                        <button id="profile-btn"
                            class="flex items-center gap-2 transition-transform duration-200 hover:scale-105">
                            <span class="inline-block h-9 w-9 overflow-hidden rounded-full bg-gray-100">
                                <svg class="h-full w-full text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                            </span>
                            <span id="nav-username" class="font-medium" style="color: var(--secondary);">Memuat...</span>
                        </button>
                        <div id="profile-menu"
                            class="absolute right-0 mt-2 w-60 origin-top-right rounded-md bg-white shadow-xl ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-30"
                            style="font-family: 'Poppins', sans-serif;">
                            <div class="py-1">
                                <div class="border-b border-gray-200 px-4 py-3">
                                    <p class="text-sm font-semibold" style="color: var(--dark);" id="dropdown-name">...</p>
                                    <p class="truncate text-xs text-gray-500" id="dropdown-email">...</p>
                                </div>
                                <a href="index.html" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-home w-4"></i><span>Beranda</span>
                                </a>
                                <a href="profil-pendaftar.html" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-user-circle w-4"></i><span>Lihat Profil</span>
                                </a>
                                <button id="logout-btn" class="flex w-full items-center gap-2 px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50">
                                    <i class="fas fa-sign-out-alt w-4"></i><span>Keluar</span>
                                </button>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-5 py-8">

        <div class="mb-8 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Dashboard Pengurus Wilayah</h1>
                <p class="text-gray-500 mt-1 text-lg">
                    Wilayah Provinsi: <span id="header-region-name" class="font-bold text-[#0284c7]">Memuat...</span>
                </p>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 max-w-md shadow-sm">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                    <p class="text-xs text-gray-700 leading-relaxed">
                        <strong>Tugas PW:</strong> Memvalidasi TBM yang telah lolos verifikasi PD, menerbitkan SK, dan mengaktifkan keanggotaan.
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-card border-l-[5px]" style="border-left-color: #0284c7;">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-500 font-medium">Perlu Validasi PW</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="count-pending-pw">0</h3>
                    </div>
                    <div class="p-2 rounded-lg text-[#0284c7]" style="background-color: #f0f9ff;"><i class="fas fa-file-signature"></i></div>
                </div>
            </div>
            <div class="stat-card border-l-green-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-500 font-medium">Aktif (Resmi)</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="count-active">0</h3>
                    </div>
                    <div class="p-2 bg-green-100 rounded-lg text-green-600"><i class="fas fa-certificate"></i></div>
                </div>
            </div>
            <div class="stat-card border-l-gray-400">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm text-gray-500 font-medium">Total TBM (Monitoring)</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="count-total">0</h3>
                    </div>
                    <div class="p-2 bg-gray-100 rounded-lg text-gray-600"><i class="fas fa-database"></i></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">

            <div class="flex flex-col md:flex-row md:items-center justify-between border-b border-gray-200 px-6 py-4 gap-4">
                <div class="flex gap-2 overflow-x-auto pb-2 md:pb-0">
                    <button class="tab-btn active" onclick="switchTab('validasi')">
                        <i class="fas fa-file-contract mr-2"></i>Perlu Validasi
                    </button>
                    <button class="tab-btn" onclick="switchTab('monitoring')">
                        <i class="fas fa-chart-bar mr-2"></i>Rekapan PD
                    </button>
                    <button class="tab-btn" onclick="switchTab('riwayat')">
                        <i class="fas fa-history mr-2"></i>Riwayat Validasi
                    </button>
                </div>

                <div class="relative w-full md:w-80">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="search-input"
                        class="pl-10 pr-4 py-2 border border-gray-300 rounded-full w-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                        placeholder="Cari TBM atau Kabupaten...">
                </div>
            </div>

            <div id="monitoring-filter" class="hidden px-6 py-3 bg-gray-50 border-b flex gap-3">
                <span class="text-sm font-medium self-center">Filter Status PD:</span>
                <select id="filter-status-pd" class="text-sm border-gray-300 rounded-md p-1" onchange="filterMonitoring()">
                    <option value="all">Semua</option>
                    <option value="3_DISETUJUI">Disetujui PD</option>
                    <option value="4_DITOLAK">Ditolak PD</option>
                </select>
            </div>

            <div class="p-6 bg-gray-50">
                <div id="loading-spinner" class="text-center py-20 hidden">
                    <i class="fas fa-spinner fa-spin fa-3x text-blue-200"></i>
                    <p class="text-gray-500 mt-4">Memuat data TBM...</p>
                </div>

                <div id="tab-validasi" class="tab-content">
                    <div id="list-validasi" class="space-y-4"></div>
                    <div id="empty-validasi" class="hidden text-center py-10">
                        <i class="fas fa-check-double fa-3x text-gray-300 mb-3"></i>
                        <p class="text-gray-500">Tidak ada data yang perlu divalidasi saat ini.</p>
                    </div>
                </div>

                <div id="tab-monitoring" class="tab-content hidden">
                    <div id="list-monitoring" class="space-y-4"></div>
                </div>

                <div id="tab-riwayat" class="tab-content hidden">
                    <div id="list-riwayat" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="detail-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="text-xl font-bold text-gray-800">Detail TBM</h2>
                <button onclick="closeModal('detail-modal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-body" id="detail-content"></div>
            <div class="modal-footer">
                <button onclick="closeModal('detail-modal')" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Tutup</button>
            </div>
        </div>
    </div>

    <div id="validasi-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header bg-blue-50">
                <h2 class="text-xl font-bold text-[#0284c7]">Validasi TBM</h2>
                <button onclick="closeModal('validasi-modal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="modal-body" id="validasi-content">
                </div>
            <div class="modal-footer justify-between">
                <button onclick="submitTolak()" class="text-red-500 font-medium hover:underline text-sm">Tolak / Kembalikan</button>
                <div class="flex gap-2">
                    <button onclick="closeModal('validasi-modal')" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">Batal</button>
                    <button onclick="generateSKAndActivate()" class="primary-btn" id="btn-submit-validasi">
                        <i class="fas fa-file-signature mr-1"></i> Terbitkan SK & Aktifkan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-notification">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Notifikasi</span>
    </div>

    <script src="../static/style/js/config.js"></script>

    <script>
        const { jsPDF } = window.jspdf;

        // === GLOBAL STATE ===
        let currentUser = null;
        let globalTbms = [];
        let activeTbmData = null; // Data TBM yang sedang dibuka di modal

        // === INIT ===
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            setupNavbar();
            fetchDashboardData();
            document.getElementById('search-input').addEventListener('input', handleSearch);
        });

        // === AUTH ===
        async function checkAuth() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) window.location.replace('index.html');
            currentUser = session.user;

            const { data: profile } = await _supabase.from('user_profiles').select('*').eq('id', currentUser.id).single();
            
            if (profile.role !== 'PW') {
                window.location.replace('index.html');
            }

            document.getElementById('nav-username').textContent = `Halo, ${profile.username}`;
            document.getElementById('dropdown-name').textContent = profile.username;
            document.getElementById('dropdown-email').textContent = profile.email;
            document.getElementById('header-region-name').textContent = profile.wilayah || '-';
        }

        // === DATA FETCHING ===
        async function fetchDashboardData() {
            document.getElementById('loading-spinner').classList.remove('hidden');
            
            // RLS sudah memfilter data sesuai Provinsi PW
            const { data: tbms, error } = await _supabase
                .from('tbm')
                .select('*')
                .order('updated_at', { ascending: false });

            document.getElementById('loading-spinner').classList.add('hidden');

            if (error) {
                showToast(error.message, 'error');
                return;
            }

            globalTbms = tbms;
            updateStats(globalTbms);
            renderAllTabs(globalTbms);
        }

        function updateStats(tbms) {
            // Perlu Validasi = Status 3_DISETUJUI (Lolos PD)
            const pendingCount = tbms.filter(t => t.status === '3_DISETUJUI').length;
            const activeCount = tbms.filter(t => t.status === '5_AKTIF').length;
            const totalCount = tbms.length;

            document.getElementById('count-pending-pw').textContent = pendingCount;
            document.getElementById('count-active').textContent = activeCount;
            document.getElementById('count-total').textContent = totalCount;
        }

        // === RENDERING TABS ===
        function renderAllTabs(tbms) {
            // 1. Tab Validasi (Status 3_DISETUJUI)
            const validasiData = tbms.filter(t => t.status === '3_DISETUJUI');
            renderValidasiList(validasiData);

            // 2. Tab Monitoring (Semua Status dari PD: 3, 4)
            // Default filter 'all' handled in filterMonitoring
            filterMonitoring(); 

            // 3. Tab Riwayat (Status 5_AKTIF)
            const riwayatData = tbms.filter(t => t.status === '5_AKTIF');
            renderRiwayatList(riwayatData);
        }

        // --- Render Tab Validasi ---
        function renderValidasiList(data) {
            const container = document.getElementById('list-validasi');
            const empty = document.getElementById('empty-validasi');
            container.innerHTML = '';

            if (data.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                data.forEach(tbm => {
                    const tbmJson = encodeURIComponent(JSON.stringify(tbm));
                    container.innerHTML += `
                        <div class="bg-white border border-blue-200 rounded-xl p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded">Lolos PD</span>
                                        <h4 class="font-bold text-lg text-gray-800">${tbm.nama_tbm}</h4>
                                    </div>
                                    <p class="text-sm text-gray-600"><i class="fas fa-map-marker-alt mr-1"></i> ${tbm.kabupaten_nama}</p>
                                    <p class="text-xs text-gray-500 mt-1">Diverifikasi PD pada: ${new Date(tbm.tgl_verifikasi_pd).toLocaleDateString('id-ID')}</p>
                                </div>
                                <button onclick="openValidasiModal('${tbmJson}')" class="primary-btn text-sm">
                                    <i class="fas fa-search-plus"></i> Validasi
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // --- Render Tab Monitoring (Rekapan PD) ---
        function filterMonitoring() {
            const statusFilter = document.getElementById('filter-status-pd').value;
            const container = document.getElementById('list-monitoring');
            container.innerHTML = '';

            let filtered = globalTbms.filter(t => ['3_DISETUJUI', '4_DITOLAK'].includes(t.status));
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(t => t.status === statusFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">Tidak ada data rekapan PD.</p>';
                return;
            }

            filtered.forEach(tbm => {
                const tbmJson = encodeURIComponent(JSON.stringify(tbm));
                const isApproved = tbm.status === '3_DISETUJUI';
                const badge = isApproved 
                    ? '<span class="bg-green-100 text-green-700 px-2 py-1 text-xs rounded font-bold">Disetujui PD</span>'
                    : '<span class="bg-red-100 text-red-700 px-2 py-1 text-xs rounded font-bold">Ditolak PD</span>';

                container.innerHTML += `
                    <div class="bg-white border border-gray-200 rounded-xl p-4 flex justify-between items-center">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                ${badge}
                                <h4 class="font-bold text-gray-800">${tbm.nama_tbm}</h4>
                            </div>
                            <p class="text-xs text-gray-500">${tbm.kabupaten_nama} | Pendaftar: ${tbm.nama_pendaftar}</p>
                        </div>
                        <button onclick="openDetailReadOnly('${tbmJson}')" class="text-gray-500 hover:text-blue-600 text-sm border px-3 py-1 rounded">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                    </div>
                `;
            });
        }

        // --- Render Tab Riwayat (Aktif/SK) ---
        function renderRiwayatList(data) {
            const container = document.getElementById('list-riwayat');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">Belum ada riwayat validasi.</p>';
                return;
            }

            data.forEach(tbm => {
                // Untuk tombol download SK & Kartu
                const tbmJson = encodeURIComponent(JSON.stringify(tbm));
                
                container.innerHTML += `
                    <div class="bg-white border border-green-200 rounded-xl p-5 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="bg-green-100 text-green-700 px-2 py-1 text-xs rounded font-bold">AKTIF</span>
                                    <h4 class="font-bold text-lg text-gray-800">${tbm.nama_tbm}</h4>
                                </div>
                                <p class="text-sm text-gray-600">No. Anggota: <span class="font-mono font-bold">${tbm.nomor_anggota_tbm}</span></p>
                                <p class="text-xs text-gray-500">Tgl SK: ${new Date(tbm.tgl_sk).toLocaleDateString('id-ID')}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="generatePdfSK('${tbmJson}')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm flex items-center gap-2">
                                    <i class="fas fa-file-pdf"></i> SK
                                </button>
                                <button onclick="generatePdfKartu('${tbmJson}')" class="bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-2 rounded text-sm flex items-center gap-2">
                                    <i class="fas fa-id-card"></i> Kartu
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // === MODAL LOGIC ===
        
        // 1. Modal Read-Only (Rekapan)
        function openDetailReadOnly(json) {
            const tbm = JSON.parse(decodeURIComponent(json));
            const content = document.getElementById('detail-content');
            
            // Gunakan helper renderDetailHTML (sama dengan dashboard-pd)
            content.innerHTML = renderDetailHTML(tbm);
            
            // Load Evidence Photos jika ada
            if (tbm.foto_verifikasi_pd) {
                loadEvidencePhotos(tbm.foto_verifikasi_pd, 'detail-evidence-container');
            }
            
            document.getElementById('detail-modal').classList.add('active');
        }

        // 2. Modal Validasi (Action)
        function openValidasiModal(json) {
            activeTbmData = JSON.parse(decodeURIComponent(json));
            const content = document.getElementById('validasi-content');
            
            let html = renderDetailHTML(activeTbmData);
            
            // Tambahkan Bagian Bukti Foto PD di paling atas
            html = `
                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-bold text-sm text-yellow-800 mb-2"><i class="fas fa-camera mr-1"></i> Foto Verifikasi PD</h3>
                    <div id="validasi-evidence-container" class="grid grid-cols-3 gap-2">
                        <div class="col-span-3 text-center text-xs text-gray-500">Memuat foto...</div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600">
                        <strong>Catatan PD:</strong> ${activeTbmData.catatan_pd || '-'}
                    </div>
                </div>
            ` + html;

            content.innerHTML = html;
            
            // Load Foto
            if (activeTbmData.foto_verifikasi_pd) {
                loadEvidencePhotos(activeTbmData.foto_verifikasi_pd, 'validasi-evidence-container');
            }

            document.getElementById('validasi-modal').classList.add('active');
        }

        // Helper Render Detail
        function renderDetailHTML(tbm) {
            const row = (lbl, val) => `<div class="detail-row"><div class="detail-label">${lbl}</div><div class="detail-value">${val || '-'}</div></div>`;
            // (Sederhanakan view untuk contoh ini, idealnya lengkap seperti dashboard-pd)
            return `
                <h3 class="detail-section-title">Profil TBM</h3>
                ${row('Nama TBM', tbm.nama_tbm)}
                ${row('Alamat', `${tbm.alamat_jalan}, ${tbm.alamat_desa}, ${tbm.alamat_kecamatan}, ${tbm.kabupaten_nama}`)}
                ${row('Ketua/Pengelola', tbm.nama_pendaftar)}
                ${row('Kontak', tbm.kontak_pendaftar)}
                
                <h3 class="detail-section-title">Kelembagaan</h3>
                ${row('Tgl Berdiri', tbm.kelembagaan_tgl_berdiri)}
                ${row('Status Izin', Array.isArray(tbm.kelembagaan_status_izin) ? tbm.kelembagaan_status_izin.join(', ') : '-')}
            `;
        }

        // Helper Load Foto (Signed URL)
        async function loadEvidencePhotos(paths, containerId) {
            const container = document.getElementById(containerId);
            if(!container) return;
            
            let html = '';
            for (const path of paths) {
                const { data } = await _supabase.storage.from('dokumen-verifikasi').createSignedUrl(path, 3600);
                if (data) {
                    html += `
                        <a href="${data.signedUrl}" target="_blank" class="block h-20 w-full rounded overflow-hidden border bg-gray-100 relative group">
                            <img src="${data.signedUrl}" class="h-full w-full object-cover">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition flex items-center justify-center">
                                <i class="fas fa-search-plus text-white opacity-0 group-hover:opacity-100"></i>
                            </div>
                        </a>`;
                }
            }
            container.innerHTML = html || '<p class="text-xs text-red-400">Gagal memuat foto.</p>';
        }

        // === ACTION: GENERATE SK & ACTIVATE ===
        async function generateSKAndActivate() {
            const btn = document.getElementById('btn-submit-validasi');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses PDF...';

            try {
                // 1. Generate Nomor SK (Format: SK/[NO_URUT]/PW-[PROV]/FTBM/[BLN]/[THN])
                // Sederhana: gunakan timestamp untuk keunikan di demo ini
                const today = new Date();
                const romawiBulan = ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"][today.getMonth()];
                const tahun = today.getFullYear();
                const nomorSK = `SK/${activeTbmData.id}/PW-FTBM/${romawiBulan}/${tahun}`;

                // 2. Update Database
                const { error } = await _supabase
                    .from('tbm')
                    .update({
                        status: '5_AKTIF',
                        validator_pw_id: currentUser.id,
                        tgl_validasi_pw: new Date().toISOString(),
                        nomor_sk: nomorSK,
                        tgl_sk: new Date().toISOString(),
                        catatan_pw: 'Validasi PW Selesai. SK Diterbitkan.'
                    })
                    .eq('id', activeTbmData.id);

                if (error) throw error;

                // 3. Generate PDF SK & Kartu (Hanya di Client untuk View/Download nanti)
                // Kita tidak simpan fisik PDF ke storage untuk hemat space, tapi generate on-the-fly saat user klik download.
                // Disini kita hanya kirim notifikasi.

                // 4. Kirim Notifikasi Email (Aktif)
                // Gunakan endpoint notify-pendaftar tapi status 5_AKTIF
                await fetch('/api/notify-pendaftar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tbm_id: activeTbmData.id,
                        user_pendaftar_id: activeTbmData.user_pendaftar_id,
                        nama_tbm: activeTbmData.nama_tbm,
                        status: '5_AKTIF',
                        catatan: 'Selamat! TBM Anda telah resmi menjadi anggota Forum TBM.'
                    })
                });

                showToast('Validasi Berhasil! SK Diterbitkan.', 'success');
                closeModal('validasi-modal');
                fetchDashboardData();

            } catch (err) {
                console.error(err);
                showToast('Gagal: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-signature mr-1"></i> Terbitkan SK & Aktifkan';
            }
        }

        // === FUNGSI GENERATE PDF (CLIENT SIDE) ===
        
        // 1. SK PENETAPAN
        window.generatePdfSK = async (json) => {
            const tbm = JSON.parse(decodeURIComponent(json));
            const doc = new jsPDF();

            // Set Font
            doc.setFont("times", "normal");

            // Header (Logo Placeholder)
            doc.setFontSize(16);
            doc.setFont("times", "bold");
            doc.text("PENGURUS WILAYAH FORUM TBM", 105, 20, null, null, "center");
            doc.text(`PROVINSI ${tbm.provinsi_nama}`, 105, 28, null, null, "center");
            
            doc.setFontSize(12);
            doc.setFont("times", "normal");
            doc.text("Sekretariat: [Alamat Sekretariat PW]", 105, 35, null, null, "center");
            doc.line(20, 38, 190, 38);

            // Judul SK
            doc.setFontSize(14);
            doc.setFont("times", "bold");
            doc.text("SURAT KEPUTUSAN", 105, 50, null, null, "center");
            doc.setFontSize(12);
            doc.text(`Nomor: ${tbm.nomor_sk}`, 105, 56, null, null, "center");

            // Isi
            doc.setFont("times", "normal");
            doc.text("Tentang:", 105, 65, null, null, "center");
            doc.text("PENETAPAN ANGGOTA FORUM TAMAN BACAAN MASYARAKAT", 105, 70, null, null, "center");

            doc.text("Pengurus Wilayah Forum TBM dengan ini memutuskan:", 20, 90);
            
            doc.text(`Nama TBM       : ${tbm.nama_tbm}`, 30, 100);
            doc.text(`Nama Pengelola : ${tbm.nama_pendaftar}`, 30, 108);
            doc.text(`Alamat         : ${tbm.alamat_jalan}, ${tbm.kabupaten_nama}`, 30, 116);
            doc.text(`Nomor Anggota  : ${tbm.nomor_anggota_tbm}`, 30, 124);

            doc.text("Telah resmi terdaftar sebagai anggota Forum Taman Bacaan Masyarakat.", 20, 140);
            doc.text("Demikian Surat Keputusan ini dibuat untuk dipergunakan sebagaimana mestinya.", 20, 148);

            // Tanda Tangan
            const tgl = new Date(tbm.tgl_sk).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
            doc.text(`Ditetapkan di: ${tbm.kabupaten_nama}`, 130, 170);
            doc.text(`Pada Tanggal : ${tgl}`, 130, 176);
            
            doc.setFont("times", "bold");
            doc.text("PENGURUS WILAYAH", 130, 185);
            doc.text("( TTD & STEMPEL )", 130, 210);
            doc.text("KETUA PW", 130, 216);

            // Save
            doc.save(`SK_Anggota_${tbm.nama_tbm}.pdf`);
        };

        // 2. KARTU ANGGOTA DIGITAL
        window.generatePdfKartu = async (json) => {
            const tbm = JSON.parse(decodeURIComponent(json));
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: [85.6, 53.98] // Ukuran Kartu ID Card CR80
            });

            // Background Warna Biru PW
            doc.setFillColor(2, 132, 199); // #0284c7
            doc.rect(0, 0, 85.6, 15, 'F'); // Header

            // Header Teks
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont("helvetica", "bold");
            doc.text("KARTU TANDA ANGGOTA", 42.8, 6, null, null, "center");
            doc.setFontSize(6);
            doc.text("FORUM TAMAN BACAAN MASYARAKAT", 42.8, 10, null, null, "center");

            // Isi
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(7);
            doc.setFont("helvetica", "bold");
            doc.text(tbm.nama_tbm.toUpperCase(), 42.8, 22, null, null, "center");

            doc.setFontSize(6);
            doc.setFont("helvetica", "normal");
            doc.text(`No: ${tbm.nomor_anggota_tbm}`, 42.8, 26, null, null, "center");
            
            doc.setFontSize(5);
            doc.text(tbm.kabupaten_nama, 42.8, 32, null, null, "center");
            doc.text(tbm.provinsi_nama, 42.8, 35, null, null, "center");

            // Footer / Validity
            doc.setFontSize(4);
            doc.setTextColor(100, 100, 100);
            doc.text("Berlaku Selama Menjadi Anggota", 42.8, 48, null, null, "center");

            doc.save(`KTA_${tbm.nama_tbm}.pdf`);
        };

        // === UTILS ===
        function switchTab(name) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${name}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showToast(msg, type='success') {
            const toast = document.getElementById('toast-notification');
            const el = document.getElementById('toast-message');
            el.textContent = msg;
            toast.className = type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function handleSearch(e) {
            const q = e.target.value.toLowerCase();
            const filtered = globalTbms.filter(t => t.nama_tbm.toLowerCase().includes(q) || t.kabupaten_nama.toLowerCase().includes(q));
            renderAllTabs(filtered);
        }

        function setupNavbar() {
            document.getElementById('profile-btn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('profile-menu').classList.toggle('hidden'); });
            window.addEventListener('click', () => document.getElementById('profile-menu').classList.add('hidden'));
            document.getElementById('logout-btn').addEventListener('click', async () => { await _supabase.auth.signOut(); window.location.replace('index.html'); });
        }
    </script>
</body>
</html>